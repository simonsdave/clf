#!/usr/bin/env python

# clf queue list | while read queue; do clfq delete $queue; done

import logging
import optparse
import os
import sys

import clf.util.clparserutil

import clfcmd.queue
import clfcmd.spider_repo
import clfcmd.creq
import clfcmd.cres


_logger = logging.getLogger("CLF_%s" % __name__)


def usage(fmt="[q|sr|creq|cres] ..."):
    print "usage: %s %s" % (os.path.split(sys.argv[0])[1], fmt)
    sys.exit(1)


class CommandLineParser(optparse.OptionParser):

    def __init__(self):
        optparse.OptionParser.__init__(
            self,
            "usage: %prog [options] [queue|sr] ...",
            option_class=clf.util.clparserutil.Option)

        default = logging.ERROR
        fmt = (
            "logging level "
            "[DEBUG,INFO,WARNING,ERROR,CRITICAL,FATAL]"
            " - default = %s"
        )
        help = fmt % logging.getLevelName(default)
        self.add_option(
            "--log",
            action="store",
            dest="logging_level",
            default=default,
            type="logginglevel",
            help=help)

def create_command_to_function_dict(module):
    return {command_name: module.doit for command_name in module.command_names}

if __name__ == "__main__":

    clp = CommandLineParser()
    (clo, cla) = clp.parse_args()

    logging.basicConfig(level=clo.logging_level)

    args = cla
    if 0 == len(args):
        usage()

    commands = {}
    commands.update(create_command_to_function_dict(clfcmd.queue))
    commands.update(create_command_to_function_dict(clfcmd.spider_repo))
    commands.update(create_command_to_function_dict(clfcmd.creq))
    commands.update(create_command_to_function_dict(clfcmd.cres))

    command = commands.get(args[0].strip().lower(), None)
    if not command:
        usage()

    command(usage, args[1:])
