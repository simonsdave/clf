#!/usr/bin/env python

# clf queue list | while read queue; do clfq delete $queue; done

import logging
import os
import sys

import boto.sqs.connection

from clf.spider_repo import SpiderRepo


_logger = logging.getLogger("CLF_%s" % __name__)


def usage(fmt="[queue|spider_repo] ..."):
    print "usage: %s %s" % (os.path.split(sys.argv[0])[1], fmt)
    sys.exit(1)

def queue_usage(fmt="[create|delete|list] ..."):
    usage("queue %s" % fmt)

def queue_create(sqs_conn, args):
    if 1 != len(args):
        queue_usage("create <queue-name>")
    queue_name = args[0]
    queue = sqs_conn.get_queue(queue_name)
    if queue:
        print "'%s' already exists" % queue.name
    else:
        queue = sqs_conn.create_queue(queue_name)
        print "Created '%s'" % queue.name

def queue_delete(sqs_conn, args):
    if 1 != len(args):
        queue_usage("delete <queue-name>")
    queue_name = args[0]
    queue = sqs_conn.get_queue(queue_name)
    if queue:
        queue.delete()
        print "Deleted '%s'" % queue_name
    else:
        print "'%s' does not exist" % queue_name

def queue_list(sqs_conn, args):
    if 0 != len(args):
        queue_usage("list")
    for queue in sqs_conn.get_all_queues():
        # this try/except block is here in case the queue is in 
        # the middle of being deleted in which case queue.count()
        # will raise an exception
        try:
            count = queue.count()
        except:
            count = 0
        print "%s (%d)" % (queue.name, count)

def queue(args):
    if not len(args):
        queue_usage()

    commands = {
        "c": queue_create,
        "create": queue_create,
        "d": queue_delete,
        "del": queue_delete,
        "delete": queue_delete,
        "l": queue_list,
        "ls": queue_list,
        "list": queue_list,
    }
    command = commands.get(args[0].strip().lower(), None)
    if not command:
        queue_usage()

    command(boto.sqs.connection.SQSConnection(), args[1:])

def spider_repo_usage(fmt="[create|delete] ..."):
    usage("spider_repo <repo-name> %s" % fmt)

def spider_repo_create(spider_repo, args):
    if 0 != len(args):
        spider_repo_usage("create")
    if spider_repo.create():
        print "Created spider repo '%s'" % spider_repo
    else:
        print "Could not create spider repo '%s'" % spider_repo

def spider_repo_delete(spider_repo, args):
    if 0 != len(args):
        spider_repo_usage("delete")
    if spider_repo.delete():
        print "Deleted spider repo '%s'" % spider_repo
    else:
        print "Could not delete spider repo '%s'" % spider_repo

def spider_repo(args):
    if len(args) < 2:
        spider_repo_usage()

    repo_name = args[0].strip()
    if not repo_name:
        spider_repo_usage()

    commands = {
        "c": spider_repo_create,
        "create": spider_repo_create,
        "d": spider_repo_delete,
        "del": spider_repo_delete,
        "delete": spider_repo_delete,
    }
    command = commands.get(args[1].strip().lower(), None)
    if not command:
        spider_repo_usage()

    command(SpiderRepo(repo_name), args[2:])

if __name__ == "__main__":

    logging.basicConfig(level=logging.INFO)

    args = sys.argv[1:]
    if 0 == len(args):
        usage()

    commands = {
        "queue": queue,
        "q": queue,
        "repo": spider_repo,
        "spider_repo": spider_repo,
        "sr": spider_repo,
    }
    command = commands.get(args[0].strip().lower(), None)
    if not command:
        usage()

    command(args[1:])
